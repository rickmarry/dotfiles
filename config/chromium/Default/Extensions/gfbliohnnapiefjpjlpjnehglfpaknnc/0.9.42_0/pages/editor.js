"use strict";var AceEditor=function(){function e(){return r.getValue()!=s}function t(){document.activeElement.blur(),Front.hidePopup()}function n(){t();var e=a();Front.onEditorSaved?(Front.onEditorSaved(e),Front.onEditorSaved=void 0):Front.contentCommand({action:"ace_editor_saved",data:e})}function o(e){var t=/[^a-zA-Z_0-9\$\-\u00C0-\u1FFF\u2C00-\uD7FF\w]+/,n=e.split(t),o={};return n.forEach(function(e){e="sk_"+e,o.hasOwnProperty(e)?o[e]++:o[e]=1}),Object.keys(o).map(function(e){return e=e.substr(3),{caption:e,value:e,score:o[e],meta:"local"}})}function a(){var e=r.getValue();return"select"===d&&(e=r.session.getLine(r.selection.lead.row),e=e.match(/.*>< ([^<]*)$/),e=e?e[1]:""),e}var i=new Mode("AceEditor");document.getElementById("sk_editor").style.height="30%";var r=ace.edit("sk_editor");r.mode="normal";var s,c=function(){return{open:function(e,t,n){PassThrough.enter();var o=n.onClose;n.onClose=function(){PassThrough.exit(),o&&o()},r.state.cm.openDialog(e,function(e){t(e),n.onClose()},n)}}}();i.addEventListener("keydown",function(n){n.sk_suppressed=!0,!Mode.isSpecialKeyOf("<Esc>",n.sk_keyName)||"normal"!==r.mode||null!==r.state.cm.state.vim.status&&""!==r.state.cm.state.vim.status||r.completer&&r.completer.activated||(e()?c.open('<span style="font-family: monospace">Quit anyway? Y/n </span><input type="text"/>',function(e){"y"===e.toLowerCase()&&(i.onExit=t,i.exit())},{bottom:!0,value:"Y",onKeyDown:function(e,t,n){e.keyCode!==KeyboardUtils.keyCodes.enter&&e.keyCode!==KeyboardUtils.keyCodes.ESC||n()}}):(i.onExit=t,i.exit()))});var u;runtime.command({action:"getAllURLs"},function(e){u=e.urls.map(function(e){var t=0,n=1;return e.hasOwnProperty("typedCount")&&(t=e.typedCount),e.hasOwnProperty("visitCount")&&(n=e.visitCount),{caption:e.url,value:e.url,score:10*t+n,meta:"local"}})});var m={identifierRegexps:[/.*/],getCompletions:function(e,t,n,o,a){a(null,u)}},l=null,p={getCompletions:function(e,t,n,a,i){l?i(null,l):Front.contentCommand({action:"getPageText"},function(e){l=o(e.data),i(null,l)})}};ace.config.loadModule("ace/ext/language_tools",function(e){r.language_tools=e,ace.config.loadModule("ace/autocomplete",function(e){e.Autocomplete.startCommand.bindKey="Tab",e.Autocomplete.prototype.commands.Space=e.Autocomplete.prototype.commands.Tab,e.Autocomplete.prototype.commands.Tab=e.Autocomplete.prototype.commands.Down,e.Autocomplete.prototype.commands["Shift-Tab"]=e.Autocomplete.prototype.commands.Up,e.FilteredList.prototype.filterCompletions=function(e,t){for(var n,o=[],a=t.toUpperCase(),i=0;n=e[i];i++){var r=n.value.toUpperCase();if(r){var s=r.indexOf(a),c=0;s!==-1&&(c|=Math.pow(2,t.length)-1<<s,n.matchMask=c,n.exactMatch=0,o.push(n))}}return o}}),r.setOptions({enableBasicAutocompletion:!0,enableLiveAutocompletion:!1,enableSnippets:!1})});var d;r.setTheme("ace/theme/chrome");var f=new Promise(function(e,o){r.setKeyboardHandler("ace/keyboard/vim",function(){var o=r.state.cm;o.on("vim-mode-change",function(e){r.mode=e.mode}),o.on("0-register-set",function(e){var t=document.activeElement;Clipboard.write(e.text),t.focus()});var s=o.constructor.Vim;e(s),s.defineEx("write","w",function(e,t){Front.contentCommand({action:"ace_editor_saved",data:a()})}),s.defineEx("wq","wq",function(e,t){i.onExit=n,i.exit(),r.state.cm.signal("vim-command-done","")}),s.map("<CR>",":wq","normal"),s.defineEx("bnext","bn",function(e,t){Front.contentCommand({action:"nextEdit",backward:!1})}),s.defineEx("bprevious","bp",function(e,t){Front.contentCommand({action:"nextEdit",backward:!0})}),s.defineEx("quit","q",function(e,n){i.onExit=t,i.exit(),r.state.cm.signal("vim-command-done","")}),Front.vimMappings.forEach(function(e){s.map.apply(s,e)});var c=r.getKeyboardHandler().defaultKeymap;Front.vimKeyMap&&Front.vimKeyMap.length&&c.unshift.apply(c,Front.vimKeyMap)})});return r.container.style.background="#f1f1f1",r.$blockScrolling=1/0,i.show=function(e){f.then(function(t){r.setValue(e.content,-1),s=e.content,r.container.querySelector("textarea").focus(),i.enter(),d=e.type,r.setFontSize(16),t.unmap("<CR>","insert"),t.unmap("<C-CR>","insert"),"url"===e.type?(t.map("<CR>",":wq","insert"),r.renderer.setOption("showLineNumbers",!1),r.language_tools.setCompleters([m]),r.container.style.height="30%"):"input"===e.type?(t.map("<CR>",":wq","insert"),r.renderer.setOption("showLineNumbers",!1),r.language_tools.setCompleters([p]),r.container.style.height=""):(t.map("<C-CR>",":wq","insert"),r.renderer.setOption("showLineNumbers",!0),r.language_tools.setCompleters([p]),r.container.style.height="30%"),r.setReadOnly("select"===e.type),t.map("<C-d>","<C-w>","insert"),t.exitInsertMode(r.state.cm),r.state.cm.setCursor(e.initial_line,0),r.state.cm.ace.renderer.scrollCursorIntoView(),setTimeout(function(){r.renderer.session.$undoManager.reset()},1),r.state.cm.ace.setOption("indentedSoftWrap",!1),r.state.cm.ace.setOption("wrap",!0)})},i}();